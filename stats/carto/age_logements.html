<html>
  <head>
    <meta charset="utf-8">
    <title>Carte sur l'âge des bâtiments au Havre</title>
	<link rel="stylesheet" href="../css/colorbrewer.css" />
    <link type="text/css" rel="stylesheet" href="../css/button.css"/>
    <script type="text/javascript" src="../js/colorbrewer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=visualization"></script>
    <script type="text/javascript" src="../js/d3.v2.js"></script>
    <script type="text/javascript" src="../carto/legende_age.js"></script>    
    <link type="text/css" rel="stylesheet" href="../css/style_balise.css"/>
    <script>
    var n, map, pointarray, heatmap, geocoder, adress;
	var Logements = [];

	d3.json("../donnees_tables/gevulieux.json", function(json) {
		var nb = json.children.length
		for(var i=0;i<nb;i++){
			var item = json.children[i];
			Logements.push({location: new google.maps.LatLng(item.lat, item.lng), weight: item.value});
		} // Création fonction json qui prend comme valeur nb avec le total de toutes les données. On créer une boucle qui va de i = 0 jusqu'à la fin du json où l'on créer une variable item. On affiche ensuite pour chaque valeur i sa latitude et sa longitude suivant la Valeur qu'elles prennent à cet endroit.
		
        var mapOptions = {
          zoom: 11,
          center: new google.maps.LatLng(49.54403690, 0.13247040),
          mapTypeId: google.maps.MapTypeId.SATELLITE
        }; //On créer la carte avec le centre qui sont nos coordonnées et le zoom situé à 11. 
		//mapTypeId affiche des images sattelites de google Earth.

        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions); // On créer une variable map qui créer un div 'map_canvas' qui a un arrière plan, sa position, sa largeur, sa longueur.

        /*
        google.maps.event.addListener(map, 'click', function() {
        	getAddress();
          });

        geocoder = new GClientGeocoder();
		*/
		
        pointArray = new google.maps.MVCArray(Logements); //On créer une variable de pointArray dans lequel on prend les coordonnées de Logements.

        heatmap = new google.maps.visualization.HeatmapLayer({
        	data: pointArray
        }); //Variable heatmap (carte de chaleur) qui prend comme données les coordonnées lat et lng

        heatmap.setMap(map);
     	
        getLegende(); //On exécute la fonction getLegende où l'on créer les carrés de couleur et le texte
        
	  });
	  
	//affichage données	 
/*	function getAddress(overlay, latlng) {
	  if (latlng != null) {
	    address = latlng;
	    geocoder.getLocations(latlng, showAddress);
	  }
	} 

//affichage données	
/*function getAddress(latLng) {
    geocoder.geocode( {'latLng': latLng},
      function(results, status) {
        if(status == google.maps.GeocoderStatus.OK) {
          if(results[0]) {
            document.getElementById("address").value = results[0].formatted_address;
          }
          else {
            document.getElementById("address").value = "No results";
          }
        }
        else {
          document.getElementById("address").value = status;
        }
      });
    }*/
	
	//affichage données
/*	function showAddress(response) {
	  map.clearOverlays();
	  if (!response || response.Status.code != 200) {
	    alert("Status Code:" + response.Status.code);
	  } else {
	    place = response.Placemark[0];
	    point = new GLatLng(place.Point.coordinates[1],
	                        place.Point.coordinates[0]);
	    marker = new GMarker(point);
	    map.addOverlay(marker);
	    marker.openInfoWindowHtml(
	    '<b>orig latlng:</b>' + response.name + '<br/>' + 
	    '<b>Latitude-Longitude:</b>' + place.Point.coordinates[1] + "," + place.Point.coordinates[0] + '<br>' +
	    '<b>Addresse:</b>' + place.address + '<br>' +
	    '<b>Code du Pays:</b> ' + place.AddressDetails.Country.CountryNameCode);
	  }
	}
*/

/*function showAddress(address) {
var zipcodex = 0;
if(geocoder)
{
    geocoder.getLocations(address, getzip); 

function getzip (response) 
    {
    if (!response || response.Status.code != 200)
        {
        alert("Sorry, we were unable to geocode the first address");
        }
    else
        {
        if(response.Placemark[0].AddressDetails.Country.AdministrativeArea.
        Locality.PostalCode.PostalCodeNumber)
            {
            zipcodex = response.Placemark[0].AddressDetails.Country.AdministrativeArea.
            Locality.PostalCode.PostalCodeNumber;
            } 

        }

    }
}

  if (geocoder) {
    geocoder.getLatLng(
      address,
      function(point) {
        if (!point) {
          alert(address + " not found");
        } else {
          map.setCenter(point, 13);
          var marker = new GMarker(point);
          map.addOverlay(marker);
    if(zipcode)
    {
    marker.openInfoWindowHtml('Zipcode:'+zipcodex);
    }
    else
    {
        marker.openInfoWindowHtml(address);
    }
        }
      }
    );

  }
}    */

      function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
      } // Fonction de bascule de la carte de chaleur. Qd on clique, les couleurs disparaissent.

    /*  function changeGradient() {
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
        heatmap.setOptions({
          gradient: heatmap.get('gradient') ? null : gradient
        });
      }*/

    /*  function changeRadius() {
        heatmap.setOptions({radius: heatmap.get('radius') ? null : 8});
      } */

      function changeOpacity() {
        heatmap.setOptions({opacity: heatmap.get('opacity') ? null : 0.2});
      }	  // On créer une fonction où l'on change l'opacité des couleurs.
    </script>
  </head>
  <body>
 	<big><b>Age des logements à la ville du Havre</b>
    <div id="map_canvas" class="bas"></div><br><br>
    <button onclick="toggleHeatmap()">Toggle Heatmap</button>
    <button onclick="changeOpacity()">Change opacity</button>
    <div align="absolute" id="legendeCarto"></div><br>

  </body>
</html>

