<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" src="../js/d3.v2.js"></script>
<script type="text/javascript" src="../js/couleur-alceane.js"></script>
<script type="text/javascript" src="../js/coors.js"></script>
<link type="text/css" rel="stylesheet" href="../css/button.css"/>
<script type="text/javascript" src="../js/legendecarto.js"></script>
<script type="text/javascript" src="../js/calculer-distance.js"></script>	
<link type="text/css" rel="stylesheet" href="../css/style-carte.css"/>	
<script type="text/javascript" src="../js/map.js"></script>	
	
<div>
<button id='VLO' class='first'>VACANCES LOGEMENTS OCCUPES</button><button id='VLV' class='first'>VACANCES LOGEMENTS VACANTS</button><button id='VGO' class='first'>VACANCES GARAGES OCCUPES</button><button id='VGV' class='first'>VACANCES GARAGES VACANTS</button><button id='VCO' class='first'>VACANCES COMMERCES OCCUPES</button><button id='VCV' class='first'>VACANCES COMMERCES VACANTS</button>
</div>
	
<script type="text/javascript">
	   
var urlJson = "http://www.gevu.org/public/stat/antenne?type=vac_log";
var urlJson1 = "http://www.gevu.org/public/stat/antenne?type=vac_gar";
var urlJson2 = "../data/vac-commerces.json";

var url = "../data/vacances_logements.csv";
var url1 = "../data/vacances_garages.csv";
var url2 = "../data/vacances_commerces.csv";	

d3.select("#VLO").on("click", function() {
	getDataGeo("../data/vacances_logements.csv","Occup");
	d3.select("#VLO").classed("active", true);
	d3.select("#VLV").classed("active", false);
	d3.select("#VGO").classed("active", false);
	d3.select("#VGV").classed("active", false);
	d3.select("#VCO").classed("active", false);
	d3.select("#VCV").classed("active", false);
});

d3.select("#VLV").on("click", function() {
	getDataGeo("../data/vacances_logements.csv","Vacant");
	d3.select("#VLV").classed("active", true);
	d3.select("#VLO").classed("active", false);
	d3.select("#VGO").classed("active", false);
	d3.select("#VGV").classed("active", false);
	d3.select("#VCO").classed("active", false);
	d3.select("#VCV").classed("active", false);
});
	 
d3.select("#VGO").on("click", function() {
	getDataGeo("../data/vacances_garages.csv","Occup");
	d3.select("#VGO").classed("active", true);
	d3.select("#VLV").classed("active", false);
	d3.select("#VLO").classed("active", false);
	d3.select("#VGV").classed("active", false);
	d3.select("#VCO").classed("active", false);
	d3.select("#VCV").classed("active", false);
});	

d3.select("#VGV").on("click", function() {
	getDataGeo("../data/vacances_garages.csv","Vacant");
	d3.select("#VGV").classed("active", true);
	d3.select("#VLV").classed("active", false);
	d3.select("#VLO").classed("active", false);
	d3.select("#VGO").classed("active", false);
	d3.select("#VCO").classed("active", false);
	d3.select("#VCV").classed("active", false);
});

d3.select("#VCO").on("click", function() {
	getDataGeo("../data/vacances_commerces.csv","Occup");
	d3.select("#VCO").classed("active", true);
	d3.select("#VLV").classed("active", false);
	d3.select("#VLO").classed("active", false);
	d3.select("#VGO").classed("active", false);
	d3.select("#VGV").classed("active", false);
	d3.select("#VCV").classed("active", false);
});

d3.select("#VCV").on("click", function() {
	getDataGeo("../data/vacances_commerces.csv","Vacant");
	d3.select("#VCV").classed("active", true);
	d3.select("#VLV").classed("active", false);
	d3.select("#VLO").classed("active", false);
	d3.select("#VGO").classed("active", false);
	d3.select("#VCV").classed("active", false);
	d3.select("#VCO").classed("active", false);
});

var geocoder = new google.maps.Geocoder();
var map;
var markersArray = [];
var kmlArray = [];
var polyArray = [];
var mt = new Array(google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.TERRAIN);
var lstKML = d3.select('#listeKML');
var z;

function getDataGeo(url, occupation){
	
	d3.csv(url, function(json) {
		z = [];
		for(var i=0; i < json.length; i++){
			var max = parseInt(json[i].occupation="Occup"+json[i].occupation="Vacant");
			var rng = ["#54f708","#f7081c"];
			z[json[i].ref]=d3.scale.log().domain([1, max]).range(rng);
			var fctColor = z[json[i].ref];
		//	var color = fctColor(json[i].coors);	
			var color = fctColor(json[i].occupation=occupation);
		//	addPolygoneByCoor(coors[json[i].ref], color);
			addCircleByCoor(url[json[i].lat] && url[json[i].lng], colorCircle);
		
/*	colorCircle = if(occupation="Occup"){
		strokeColor(addCircleByCoor) : "#43FB00"
	}
	
	colorCircle = if(occupation="Vacant"){
		strokeColor(addCircleByCoor) : "#FB1900"
	} */
		}
		
	});	
	
}

function setGeoParam(params) {
	var flexApp = parent.document.getElementById('diag');
	flexApp.modifLieu(params);
}

function geocodePosition(pos) {
  geocoder.geocode({
    latLng: pos
  }, function(responses) {
    if (responses && responses.length > 0) {
    	adresse = responses[0].formatted_address;
    } else {
      adresse = "pas d'adresse...";
    }
	setGeoParam('[{"LatLng":"'+pos+'","zoom":"'+map.getZoom()+'","adresse":"'+adresse+'","mapType":"'+map.getMapTypeId()+'"}]');  

  });
}

//Deletes all markers in the array by removing references to them
function deleteOverlays() {
  if (markersArray) {
    for (i in markersArray) {
      markersArray[i].setMap(null);
    }
    markersArray.length = 0;
  }	  
}

//Removes the overlays from the map, but keeps them in the array
function clearOverlays() {
  if (markersArray) {
    for (i in markersArray) {
      markersArray[i].setMap(null);
    }
  }
  clearKml();
}

//Removes the overlays from the map, but keeps them in the array
document.clearKml = function(params) {
  if (kmlArray) {
    for (i in kmlArray) {
    	if(kmlArray[i]==params[0])kmlArray[i].setMap(null);
    }
  }
}

function deleteCouches() {
	  if (kmlArray) {
	    for (i in kmlArray) {
	    	kmlArray[i].setMap(null);
	    }
	    kmlArray.length = 0;
	  }
	  if (polyArray) {
		    for (i in polyArray) {
		    	polyArray[i].setMap(null);
		    }
		    polyArray.length = 0;
		  }
	  d3.select('#listeCouche').remove();	  
	  d3.select('#couches').append("div").attr("id", "listeCouche");	   
	}

// Shows any overlays currently in the array
function showOverlays() {
  if (markersArray) {
    for (i in markersArray) {
    	if(kmlArray[i]==params[0])kmlArray[i].setMap(map);
    }
  }
  showKml();  
}

function initialize() {
	var options = {
		zoom: 8,
		center: new google.maps.LatLng(49.49, 0.11),
		mapTypeId: google.maps.MapTypeId.TERRAIN,
		streetViewControl: true,
		mapTypeControlOptions: {
			mapTypeIds:mt 
		}
	};	
	
	map = new google.maps.Map(document.getElementById('mapCanvas'),options);

var markerCenter = null;
var markerResize = null;
	
				function addressChange(lat, lng)
			{
				var optionsCircle = { 
					center: map.getCenter(),
					fillOpacity: 0.5,
					fillColor: colorCircle,
					strokeOpacity: 0,
					radius: 15000,
					map: map
					}
					
				circle = new google.maps.Circle(optionsCircle);

				var optionsMarker = { position: new google.maps.LatLng (lat, lng),
									map: map
									}
									
				markerCenter = new google.maps.Marker(optionsMarker);

				var optionsMarker = { position: new google.maps.LatLng (lat, parseFloat(lng) + 15000*kmToLng),
									map: map,
									}
									
				markerResize = new google.maps.Marker(optionsMarker);
			}
			
				marker = markers[j];
						
						var lat = marker['lat'];
						var lng = marker['lng'];
						
						var optionsMarqueur = {
							position: new google.maps.LatLng(lat,lng),
							map: map,
						}
			
			

}

document.addKml = function(params){
	
	if(!kmlArray[params[2]]){
		var kmlLayer = new google.maps.KmlLayer(params[0]);
		kmlLayer.setMap(map);
		kmlArray[params[2]] = kmlLayer;
		addCouche(params[2], "ckKml_"+params[2], params[1]);
	}	
}

function addCouche(id, idElem, texte){

	d3.select('#listeCouche')
		.append("span")
		.text(texte)
		.append("input")
			.attr("type", "checkbox")
			.attr("id", idElem)
			.attr("checked","checked")
			.attr("onclick","showCouche("+id+",'"+idElem+"')");	
}

function showCouche(id, idElem){

	var chk = document.getElementById(idElem);
	var arrIdElem = idElem.split("_");
	if(chk.checked){
		if(arrIdElem[0]=="ckKml")kmlArray[id].setMap(map); 
		if(arrIdElem[0]=="ckPoly")polyArray[id].setMap(map); 
	}else{
		if(arrIdElem[0]=="ckKml")kmlArray[id].setMap(null); 
		if(arrIdElem[0]=="ckPoly")polyArray[id].setMap(null); 
	}	  		
	
}

document.addMarker = function(params){

	deleteOverlays();
	
	var latLng = new google.maps.LatLng(params[0], params[1]);

	var marker = new google.maps.Marker({
		    position: latLng,
		    title: params[5]+" - "+params[6],
		    map: map,
		    draggable: true
		  });
		  
	//change le fond
	if(params[2]=="hybrid")map.setMapTypeId(google.maps.MapTypeId.HYBRID);
	if(params[2]=="roadmap")map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
	if(params[2]=="terrain")map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
	if(params[2]=="satellite")map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
	
	//on ajoute le kml
	if(params[4]!=""){
		polyArray[params[5]] = addPolygone(params[4]);
		addCouche(params[5], "ckPoly_"+params[5], params[6]);
	}
	  
	google.maps.event.addListener(marker, 'dragend', function() {
		geocodePosition(marker.getPosition());
	});
	
	markersArray.push(marker);	  

	//bouge la carte.
	map.setCenter(latLng);
	//change le zoom
	// ATTENTION il faut le faire aprÃ¨s avoir changer de fond car il n'ont pas tous le mÃªme niveau de zoom max
	map.setZoom(parseInt(params[3]));
	
	return "OK";

}

document.zoom = function(params){
	map.setZoom(parseInt(params[0]));	
}
		
function addPolygoneByCoor(coor, couleur) {
	
	var arrCoor = coor.split(" ");
	var planCoor = [], posi;
	for (i in arrCoor) {
		posi = $.trim(arrCoor[i]);
		if(posi!=""){
			posi = posi.split(",");
			planCoor.push(new google.maps.LatLng(posi[1], posi[0]));			
		}
	}

	var planPath = new google.maps.Polygon({
		    paths: planCoor,
		    strokeColor: "#FF0000",
		    strokeOpacity: 10,
		    strokeWeight: 2,
			fillColor: couleur,
		    //fillColor: "#FF0000",
		    fillOpacity: 0.8
		  });	

	planPath.setMap(map);
		  
	return planPath;
}


function addPolygone(kml) {
	
	var xml = getCoor(kml);
	 
	var coor = xmlDoc.getElementsByTagName("coordinates")[0].textContent;

	var arrCoor = coor.split(" ");
	 
	var planCoor = [], posi;
	for (i in arrCoor) {
		posi = $.trim(arrCoor[i]);
		if(posi!=""){
			posi = posi.split(",");
			planCoor.push(new google.maps.LatLng(posi[1], posi[0]));			
		}
	}

	var planPath = new google.maps.Polygon({
		    paths: planCoor,
		    strokeColor: "#FF0000",
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: "#FF0000",
		    fillOpacity: 0.35
		  });	

	planPath.setMap(map);
		  
	return planPath;
}

function getCoor(txt){
	
	if (window.DOMParser)
	  {
	  parser=new DOMParser();
	  xmlDoc=parser.parseFromString(txt,"text/xml");
	  }
	else // Internet Explorer
	  {
	  xmlDoc=new ActiveXObject("Microsoft.XMLDOM");
	  xmlDoc.async=false;
	  xmlDoc.loadXML(txt);
	} 
	return xmlDoc;
}

// Onload handler to fire off the app.
google.maps.event.addDomListener(window, 'load', initialize);


</script>
</head>
<body>
  <style>
  #mapCanvas {
    width: 100%;
    height: 100%;
    float: left;
  }
  </style>
  
  <div id="couches" style="overflow:auto;" >Couches : 
  	  <div style="cursor:pointer;" onclick="deleteCouches()" >(tout effacer)</div>
	  <div id="listeCouche"></div>
  </div>

	<table>
    	<tr>
    		<td><div id="chart" ></div></td>
    		<td><div id="legende" ></div></td>
    	</tr>
    </table>
  <div id="mapCanvas"></div>	

					 
	
</body>
</html>